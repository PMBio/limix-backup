#!/bin/bash

if [[ $# -ne 1 ]]; then
    echo -n "Wrong number of arguments. You must supply Limix version "
    echo "as the first argument."
    exit 1
fi
LIMIX_VERSION=$1
TAG=v${LIMIX_VERSION}

export REMOTE_REPOSITORY="ssh://git@github.com/PMBio/limix.git"
export REMOTE_BRANCH="refs/heads/production"

set -e

if [[ ! -z $CI_COMMIT_ID ]]; then
    echo "Deploying Limix ${LIMIX_VERSION} to GitHub."
    mkdir -p "$HOME/.ssh"
    ssh-keyscan -t rsa github.com > ~/.ssh/known_hosts
    echo -e $PRIVATE_SSH_KEY >> $HOME/.ssh/id_rsa
    chmod -R 700 $HOME/.ssh
    git config user.email "${CI_COMMITTER_EMAIL}"
    git config user.name "${CI_COMMITTER_NAME}"
    echo "Ponto 1"
    git fetch --all
    echo "Ponto 2"
    git tag -a ${TAG} ${CI_COMMIT_ID} -m "version ${LIMIX_VERSION}"
    echo "Ponto 3"
    git push --tags ${REMOTE_REPOSITORY} ${CI_COMMIT_ID}:${REMOTE_BRANCH}
    echo "Ponto 4"
    github-release release \
        --user ${CI_COMMITTER_USERNAME} \
        --repo ${REMOTE_REPOSITORY} \
        --tag ${TAG} \
        --name "Automatically generated release for Limix \
                version ${LIMIX_VERSION}" \
        --description "Commit message: ${CI_MESSAGE}"
    echo "Ponto 5"
else
    echo "We won't try to deploy it because CI_COMMIT_ID is missing."
    exit 1
fi
